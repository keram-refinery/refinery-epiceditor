(function(window, $){'use strict';refinery.Object.create({name:"EpicEditor",module:"editor",options:{container:"epiceditor",textarea:null,basePath:"/assets/refinery/epiceditor/",clientSideStorage:!0,localStorageName:"epiceditor",useNativeFullscreen:!0,parser:marked,file:{name:"refinery",defaultContent:"",autoSave:!1},theme:{base:"themes/base/epiceditor.css",preview:"themes/preview/refinery.css",editor:"themes/editor/refinery.css"},button:{preview:!0,fullscreen:!0},focusOnLoad:!1,shortcut:{modifier:18,fullscreen:70,preview:80},
string:{togglePreview:t("refinery.editor.toggle_preview_mode"),toggleEdit:t("refinery.editor.toggle_edit_mode"),toggleFullscreen:t("refinery.editor.enter_fullscreen")}},editor:null,insert:function(b){this.editor.edit();this.editor.editorIframeDocument.execCommand("insertText",!1,b)},h:function(b){var c=this,a;b=$("<button/>",{title:t("refinery.editor.images_dialog_button_title"),"class":"editor-images-dialog-btn refinery-btn"}).prependTo(b);a=refinery("admin.ImagesDialog");b.on("click",function(d){d.preventDefault();
d.stopPropagation();a.init().open();return!1});a.on("insert",function(d){var a="![%alt](%url)";d.url?(a=a.replace("%alt",d.alt),a=a.replace("%url",d.url),c.insert(a)):c.g(d.id)});c.a=a},g:function(b){var c=this,a;a=refinery("admin.ImageDialog",{image_id:b,buttons:[{text:"Insert",click:function(){a.insert(a.holder)}},{text:"Back to the library",click:function(){a.close();a.destroy();c.a.open()}}]}).init();a.on("insert",function(d){var b;b="![%alt](%url)".replace("%alt",d.alt);b=b.replace("%url",d.sizes[d.size]);
c.insert(b);a.destroy()});a.open()},j:function(b){var c=this,a;b=$("<button/>",{title:t("refinery.editor.resources_dialog_button_title"),"class":"editor-resources-dialog-btn refinery-btn"}).prependTo(b);a=refinery("admin.ResourcesDialog");b.on("click",function(d){d.preventDefault();d.stopPropagation();a.init().open();return!1});a.on("insert",function(a){c.insert('<a href="'+a.url+'" class="file '+a.ext+'" title="'+a.name+" - "+a.size+' bytes " >'+a.name+"</a>")});c.c=a},i:function(b){var c=this,a;
b=$("<button/>",{title:t("refinery.editor.pages_dialog_button_title"),"class":"editor-pages-dialog-btn refinery-btn"}).prependTo(b);a=refinery("admin.PagesDialog");b.on("click",function(d){d.preventDefault();d.stopPropagation();a.init().open();return!1});a.on("insert",function(a){var b;b="[%title](%url)".replace("%title",a.title);b=b.replace("%url",a.url);c.insert(b)});c.b=a},e:function(){this.holder.removeClass("epiceditor-on");this.a.destroy();this.c.destroy();this.b.destroy();this.editor.unload()},
destroy:function(b){var c,a;if(this.is("initialised")){if(this.editor){c=$(this.options.textarea);a=c.val();try{this.e()}catch(d){"object"===typeof console&&"function"===typeof console.log&&console.log(d)}this.editor=null;c.val(a)}this.a&&this.a.destroy(!0);this.c&&this.c.destroy(!0);this.b&&this.b.destroy(!0);this.holder.find(".epiceditor-holder").remove();this.d.remove()}this._destroy(b);return this},f:function(){function b(){var b;a.addClass("epiceditor-on");e.remove(f.file.name);e.load();b=$(e.getElement("wrapper")).find("#epiceditor-utilbar");
c.h(b);c.j(b);c.i(b)}var c=this,a=c.holder,d=a.find("textarea"),f=c.options,e;f.textarea=d.get(0);c.editor=e=new EpicEditor(f);c.d.on("click",function(h){var g=d.val();h.preventDefault();a.hasClass("epiceditor-on")?(c.e(),d.val(g)):(b(),e.importFile(f.file.name,g))});b()},init:function(b){var c;this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(b),c=$("<div/>",{"class":"epiceditor-holder"}).appendTo(b),this.options.container=c.get(0),this.options.file.name="refinery"+this.uid,
this.d=$("<button/>",{"class":"epiceditor-toggle-button",text:t("refinery.editor.toggle_editor")}).appendTo(b),this.f(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});refinery.admin.ui.editorEpicEditor=function(b){var c=b.find(".ui-tabs"),a=[];b.find("textarea.replace-with-editor").each(function(){var b=$(this).parent();a[a.length]=refinery("editor.EpicEditor").init(b)});c.on("tabsactivate",function(){for(var b=a.length-1;0<=b;b--)a[b].editor&&a[b].editor.reflow()})};}(window, jQuery));
