(function(window, $){'use strict';refinery.Object.create({name:"EpicEditor",module:"editor",options:{container:"epiceditor",textarea:null,basePath:"/assets/refinery/epiceditor/",clientSideStorage:!0,localStorageName:"epiceditor",useNativeFullscreen:!0,parser:marked,file:{name:"refinery",defaultContent:"",autoSave:!1},theme:{base:"themes/base/epiceditor.css",preview:"themes/preview/refinery.css",editor:"themes/editor/refinery.css"},button:{preview:!0,fullscreen:!0},focusOnLoad:!1,shortcut:{modifier:18,fullscreen:70,preview:80},
string:{togglePreview:t("refinery.editor.toggle_preview_mode"),toggleEdit:t("refinery.editor.toggle_edit_mode"),toggleFullscreen:t("refinery.editor.enter_fullscreen")}},editor:null,insert:function(a){this.editor.edit();this.editor.editorIframeDocument.execCommand("insertText",!1,a)},f:function(a){var c=this,b;a=$("<button/>",{title:t("refinery.editor.images_dialog_button_title"),"class":"editor-images-dialog-btn refinery-btn"}).prependTo(a);b=refinery("admin.ImagesDialog");a.on("click",function(e){e.preventDefault();
e.stopPropagation();b.init().open();return!1});b.on("insert",function(b){var a="![%alt](%url)";b.url?(a=a.replace("%alt",b.alt),a=a.replace("%url",b.url),c.insert(a)):c.e(b.id)});c.a=b},e:function(a){var c=this,b;b=refinery("admin.ImageDialog",{image_id:a,buttons:[{text:"Insert",click:function(){b.insert(b.holder)}},{text:"Back to the library",click:function(){b.close();b.destroy();c.a.open()}}]}).init();b.on("insert",function(a){var d;d="![%alt](%url)".replace("%alt",a.alt);d=d.replace("%url",a.sizes[a.size]);
c.insert(d);b.destroy()});b.open()},h:function(a){var c=this,b;a=$("<button/>",{title:t("refinery.editor.resources_dialog_button_title"),"class":"editor-resources-dialog-btn refinery-btn"}).prependTo(a);b=refinery("admin.ResourcesDialog");a.on("click",function(a){a.preventDefault();a.stopPropagation();b.init().open();return!1});b.on("insert",function(a){c.insert('<a href="'+a.url+'" class="file '+a.ext+'" title="'+a.name+" - "+a.size+' bytes " >'+a.name+"</a>")});c.j=b},g:function(a){var c=this,b;
a=$("<button/>",{title:t("refinery.editor.pages_dialog_button_title"),"class":"editor-pages-dialog-btn refinery-btn"}).prependTo(a);b=refinery("admin.PagesDialog");a.on("click",function(a){a.preventDefault();a.stopPropagation();b.init().open();return!1});b.on("insert",function(a){var b;b="[%title](%url)".replace("%title",a.title);b=b.replace("%url",a.url);c.insert(b)});c.i=b},c:function(){this.holder.removeClass("wysiwyg-editor-on");this.a.destroy();this.j.destroy();this.i.destroy();this.editor.unload()},
destroy:function(){var a,c;if(this.is("initialised")){if(this.editor){a=$(this.options.textarea);c=a.val();try{this.c()}catch(b){refinery.log(b)}this.editor=null;a.val(c)}this.holder.find(".wysiwyg-editor-holder").remove();this.b.remove()}this._destroy();return this},d:function(){function a(){var a;b.addClass("wysiwyg-editor-on");f.remove(d.file.name);f.load();a=$(f.getElement("wrapper")).find("#epiceditor-utilbar");c.f(a);c.h(a);c.g(a)}var c=this,b=c.holder,e=b.find("textarea"),d=c.options,f;d.textarea=
e.get(0);c.editor=f=new EpicEditor(d);c.b.on("click",function(h){var g=e.val();h.preventDefault();b.hasClass("wysiwyg-editor-on")?(c.c(),e.val(g)):(a(),f.importFile(d.file.name,g))});a()},init:function(a){var c;this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),c=$("<div/>",{"class":"wysiwyg-editor-holder"}).appendTo(a),this.options.container=c.get(0),this.options.file.name="refinery"+this.uid,this.b=$("<button/>",{"class":"epiceditor-toggle-button",text:t("refinery.editor.toggle_editor")}).appendTo(a),
this.d(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});refinery.admin.ui.editorEpicEditor=function(a){var c=a.find(".ui-tabs"),b=[];a.find(".wysiwyg-editor-wrapper").each(function(){b[b.length]=refinery("editor.EpicEditor").init($(this))});c.on("tabsactivate",function(){for(var a=b.length-1;0<=a;a--)b[a].editor&&b[a].editor.reflow()})};}(window, jQuery));
