(function(window, $){'use strict';refinery.Object.create({name:"EpicEditor", module:"epiceditor", options:{container:"epiceditor", textarea:null, basePath:"/assets/refinery/epiceditor/", clientSideStorage:!0, localStorageName:"epiceditor", useNativeFullscreen:!0, parser:marked, file:{name:"refinery", defaultContent:"", autoSave:!1}, theme:{base:"themes/base/epiceditor.css", preview:"themes/preview/refinery.css", editor:"themes/editor/refinery.css"}, button:{preview:!0, fullscreen:!0}, focusOnLoad:!1, shortcut:{modifier:18, 
fullscreen:70, preview:80}, string:{togglePreview:t("refinery.epiceditor.toggle_preview_mode"), toggleEdit:t("refinery.epiceditor.toggle_edit_mode"), toggleFullscreen:t("refinery.epiceditor.enter_fullscreen")}}, editor:null, insert:function(a) {
  this.editor.edit();
  this.editor.editorIframeDocument.execCommand("insertText", !1, a);
}, e:function(a) {
  var c = this, b;
  a = $("<button/>", {title:t("refinery.epiceditor.images_dialog_button_title"), "class":"editor-images-dialog-btn refinery-btn"}).prependTo(a);
  b = refinery("admin.ImagesDialog");
  a.on("click", function(d) {
    d.preventDefault();
    d.stopPropagation();
    b.init().open();
    return!1;
  });
  b.on("insert", function(d) {
    var b = "![%alt](%url)";
    d.url ? (b = b.replace("%alt", refinery.htmlEncode(d.alt)), b = b.replace("%url", d.url), c.insert(b)) : c.d(d.id);
  });
  c.images_dialog = b;
}, d:function(a) {
  var c = this, b;
  b = refinery("admin.ImageDialog", {image_id:a, buttons:[{text:"Insert", "class":"submit-button", click:function() {
    b.insert(b.holder);
  }}, {text:"Back to the library", click:function() {
    b.close();
    b.destroy();
    c.images_dialog.open();
  }}]}).init();
  b.on("insert", function(d) {
    var a;
    a = "![%alt](%url)".replace("%alt", refinery.htmlEncode(d.alt));
    a = a.replace("%url", d.sizes[d.size]);
    c.insert(a);
    b.destroy();
  });
  b.open();
}, g:function(a) {
  var c = this, b;
  a = $("<button/>", {title:t("refinery.epiceditor.resources_dialog_button_title"), "class":"editor-resources-dialog-btn refinery-btn"}).prependTo(a);
  b = refinery("admin.ResourcesDialog");
  a.on("click", function(d) {
    d.preventDefault();
    d.stopPropagation();
    b.init().open();
    return!1;
  });
  b.on("insert", function(b) {
    c.insert('<a href="' + b.url + '" class="file ' + b.ext + '" title="' + b.name + " - " + b.size + ' bytes " >' + b.name + "</a>");
  });
  c.resources_dialog = b;
}, f:function(a) {
  var c = this, b;
  a = $("<button/>", {title:t("refinery.epiceditor.links_dialog_button_title"), "class":"editor-links-dialog-btn refinery-btn"}).prependTo(a);
  b = refinery("admin.LinksDialog");
  a.on("click", function(a) {
    a.preventDefault();
    a.stopPropagation();
    b.init().open();
    return!1;
  });
  b.on("insert", function(b) {
    var a;
    a = "[%title](%url)".replace("%title", refinery.htmlEncode(b.title));
    a = a.replace("%url", b.url);
    c.insert(a);
  });
  c.links_dialog = b;
}, b:function() {
  this.holder.removeClass("wysiwyg-editor-on");
  this.images_dialog.destroy();
  this.resources_dialog.destroy();
  this.links_dialog.destroy();
  this.editor.unload();
}, destroy:function() {
  var a, c;
  if (this.is("initialised")) {
    if (this.editor && this.editor.is("loaded")) {
      a = $(this.options.textarea);
      c = a.val();
      try {
        this.b();
      } catch (b) {
        refinery.log(b);
      }
      this.editor = null;
      a.val(c);
    }
    this.holder.find(".wysiwyg-editor-holder").remove();
    this.a.remove();
  }
  this._destroy();
  return this;
}, c:function() {
  function a() {
    var a;
    b.addClass("wysiwyg-editor-on");
    f.remove(e.file.name);
    f.load();
    a = $(f.getElement("wrapper")).find("#epiceditor-utilbar");
    c.e(a);
    c.g(a);
    c.f(a);
  }
  var c = this, b = c.holder, d = b.find("textarea"), e = c.options, f;
  e.textarea = d.get(0);
  c.editor = f = new EpicEditor(e);
  c.a.on("click", function(h) {
    var g = d.val();
    h.preventDefault();
    b.hasClass("wysiwyg-editor-on") ? (c.b(), d.val(g)) : (a(), f.importFile(e.file.name, g));
  });
  a();
}, init:function(a) {
  var c;
  this.is("initialisable") && (this.is("initialising", !0), this.holder = a, c = $("<div/>", {"class":"wysiwyg-editor-holder"}).appendTo(a), this.options.container = c.get(0), this.options.file.name = "refinery" + this.uid, this.a = $("<button/>", {"class":"wysiwyg-toggle-button", text:t("refinery.epiceditor.toggle_editor")}).appendTo(a), this.c(), this.is({initialised:!0, initialising:!1}), this.trigger("init"));
  return this;
}});
refinery.admin.ui.editorEpicEditor = function(a, c) {
  var b = a.find(".ui-tabs"), d = [], e;
  a.find(".wysiwyg-editor-wrapper").each(function() {
    e = refinery("epiceditor.EpicEditor").init($(this));
    d[d.length] = e;
    c.addObject(e);
  });
  b.on("tabsactivate", function() {
    for (var a = d.length - 1;0 <= a;a--) {
      d[a].editor && d[a].editor.reflow();
    }
  });
};
}(window, jQuery));
